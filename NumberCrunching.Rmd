---
title: "Processing raw maple data"
author: "Erika Barthelmess"
date: "8/22/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
During summmer 2019, we built out a new data entry portal on the Nature Up North website to allow easier submission of maple data.  We would like to process the historical data into a csv that can be easily batch uploaded to the website so that folks have access to all of the data.  That's what this code is for.

## Set up the workspace

```{r}
rm(list = ls())
library(ggplot2)
library(tidyverse)
```

## Now pull in the data
I am taking data from the excel file called "all_maple_monitoring_through_fall2017.xlsx" which is found in Nature Up North/Citizen Science/MapleMonitoring/Data on dropbox.

```{r}
library(readr)
Trees <- read_csv("FallTrees.csv")
```
There are 1502 observations of 24 variables.

## Now do some data cleanup.

### Begin by getting rid of the spring data observations
```{r}
Trees<-select(Trees, -starts_with("Leaf"))
Trees<-select(Trees, -Fruit)
```

### Continue by making sure that levels of factor variables are correct.

Create factor variables
```{r}
Trees$Season<-as.factor(Trees$Season)
Trees$Species<-as.factor(Trees$Species)
Trees$Urbanization<-as.factor(Trees$Urbanization)
Trees$Habitat<-as.factor(Trees$Habitat)
Trees$Shading<-as.factor(Trees$Shading)
```
###Now check for levels of each factor 
Make sure there are not multiple spellings of factor levels, etc. Repair any problems as they arise.

```{r}
levels(Trees$Season)
```
Season looks good.
```{r}
levels(Trees$Species)
```

Species also looks good.
```{r}
levels(Trees$Urbanization)
```
Looks good.
```{r}
levels(Trees$Habitat)
```
Habitat also looks good.
```{r}
levels(Trees$Shading)
```
Looks good.  None of the factor variables have incorrect levels assigned.



###Now check for errors in numeric variables
####Examine latitude and longitude
Latitude: First look at the ranges of values
```{r}
summary(Trees$Latitude)
```
Let's make a plot so see how many really big numbers there are
```{r}
ggplot(Trees, aes(Latitude))+
  geom_histogram()
```

All the latitude values appear to be ok, though some may be wrong.


Longitude: First look at the ranges of values

```{r}
summary(Trees$Longitude)
```
Let's make a plot so see how many really big numbers there are
```{r}
ggplot(Trees, aes(Longitude))+
  geom_histogram()
```
All longitude values are negative.  Some are unusual, (e.g. -90, -7) but we're not going to change any data at this point.

####Other numeric variables
Can now move on to next numeric variable, circumference.
Look at range of tree circumferences.
```{r}
summary(Trees$Circumference)
```
Let's make a plot so see how many really big numbers there are (e.g. 241.00!)
```{r}
ggplot(Trees, aes(Circumference))+
  geom_histogram()
```
Ok.  Numeric variables look good.  


###Now populate other columns
####Serial
Add a unique ID to each row of data
```{r}
Trees$Serial<-(1:1502)
```
####Julian
Now see if I can add a julian date.  Note that some of the dates in the date fields are March, rather than a fall date.  I think these are the dates the data were contributed rather than the dates the observations were made.  I am not changing them.  The data are the data.

Begin by making the Date column into a date class with Lubridate

```{r}
library(lubridate)
Trees$Date<-mdy(Trees$Date)
```
And now get the Julian date, also using lubridate
```{r}
Trees$Julian<-yday(Trees$Date)
```
## Final Steps - Concatenate and export file
We need a unique ID per tree, but we don't want each observation of the same tree to count as a different tree.  Thus, we are concatenating a bunch of variables into a string that should be unique to each tree, but not each observation, so that we can identify all of the observations that appear to be from the same tree.

To do so, we will concatenate the columns Tree ID, Species, Latitude, Longitude, Urbanization, Habitat, Shading and Circumference.  These will be used to determine which rows are unique trees.

```{r}
Trees$UniqueID<-paste(Trees$`Tree ID`, Trees$Species, Trees$Latitude, Trees$Longitude, Trees$Urbanization, Trees$Habitat, Trees$Shading, Trees$Circumference, sep = "_")
```
Now write the file to a new csv
```{r}
write.csv(Trees, "FallTreesProcessed.csv")
```





